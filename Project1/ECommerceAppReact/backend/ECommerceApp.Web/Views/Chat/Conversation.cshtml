@model ECommerceApp.Domain.Entities.Conversation
@{
    ViewData["Title"] = "Chat";
    var currentUserId = ViewBag.CurrentUserId as string;
    var messages = Model.Messages ?? new List<ECommerceApp.Domain.Entities.Message>();
    var otherUser = Model.BuyerId == currentUserId ? Model.Seller : Model.Buyer;
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body d-flex align-items-center">
                    <a asp-action="Index" class="btn btn-link text-dark me-3">
                        <i class="fas fa-arrow-left fa-lg"></i>
                    </a>
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                         style="width: 45px; height: 45px;">
                        <span class="fw-bold">@otherUser?.FirstName?.Substring(0, 1)@otherUser?.LastName?.Substring(0, 1)</span>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="mb-0">@otherUser?.FirstName @otherUser?.LastName</h5>
                        @if (Model.Product != null)
                        {
                            <small class="text-muted">
                                <i class="fas fa-box me-1"></i>About: @Model.Product.Name
                            </small>
                        }
                    </div>
                    @if (Model.Product != null)
                    {
                        <a asp-controller="Product" asp-action="Details" asp-route-id="@Model.ProductId" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye me-1"></i>View Product
                        </a>
                    }
                </div>
            </div>

            <!-- Messages -->
            <div class="card border-0 shadow-sm">
                <div class="card-body" id="messageContainer" style="height: 400px; overflow-y: auto;">
                    @if (!messages.Any())
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No messages yet. Start the conversation!</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var msg in messages)
                        {
                            var isMe = msg.SenderId == currentUserId;
                            <div class="d-flex mb-3 @(isMe ? "justify-content-end" : "justify-content-start")">
                                <div class="@(isMe ? "bg-primary text-white" : "bg-light")" 
                                     style="max-width: 70%; padding: 10px 15px; border-radius: 18px;">
                                    <p class="mb-1">@msg.Content</p>
                                    <small class="@(isMe ? "text-white-50" : "text-muted")">
                                        @msg.SentAt.ToString("HH:mm")
                                        @if (isMe && msg.IsRead)
                                        {
                                            <i class="fas fa-check-double ms-1"></i>
                                        }
                                    </small>
                                </div>
                            </div>
                        }
                    }
                </div>

                <!-- Message Input -->
                <div class="card-footer bg-white border-top">
                    <form asp-action="SendMessage" method="post" class="d-flex gap-2">
                        <input type="hidden" name="conversationId" value="@Model.Id" />
                        <input type="text" name="content" class="form-control" 
                               placeholder="Type a message..." autocomplete="off" required />
                        <button type="submit" class="btn btn-primary px-4">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        var container = document.getElementById('messageContainer');
        container.scrollTop = container.scrollHeight;

        // SignalR Connection
        var connection = new signalR.HubConnectionBuilder().withUrl("/chathub").build();

        connection.on("ReceiveMessage", function (user, message, timestamp, senderId) {
            var currentUserId = '@currentUserId';
            var isMe = senderId === currentUserId;
            
            // XSS Protection: Encode message if needed, but for now simple text
            // Note: In real app use textNode or library to sanitise
            
            var msgHtml = `
                <div class="d-flex mb-3 ${isMe ? 'justify-content-end' : 'justify-content-start'}">
                    <div class="${isMe ? 'bg-primary text-white' : 'bg-light'}" 
                         style="max-width: 70%; padding: 10px 15px; border-radius: 18px;">
                        <p class="mb-1">${message}</p>
                        <small class="${isMe ? 'text-white-50' : 'text-muted'}">
                            ${timestamp}
                        </small>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', msgHtml);
            container.scrollTop = container.scrollHeight;
        });

        connection.start().then(function () {
            // Join group for this conversation
            connection.invoke("JoinConversation", "@Model.Id").catch(function (err) {
                return console.error(err.toString());
            });
        }).catch(function (err) {
            return console.error(err.toString());
        });
    </script>
}
